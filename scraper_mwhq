from __future__ import annotations
import requests
from typing import List, Dict

BASE_DOMAIN = "https://www.mywardrobehq.com"
API_ENDPOINT = f"{BASE_DOMAIN}/get-products"

# Replace this with your current mwhqsession cookie from Safari
MW_SESSION_COOKIE = "mwhqsession=9s4huvja3jes9pj02dn4iik1c8847oaj"

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) "
                  "AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.1 Safari/605.1.15",
    "Accept": "*/*",
    "X-Requested-With": "XMLHttpRequest",
    "Cookie": f"mwhqsession={MW_SESSION_COOKIE};"
}

def fetch_products_page(query: str, page: int = 0) -> List[Dict]:
    """Fetch a single page of products from MyWardrobeHQ API."""
    params = {
        "featured": "1",
        "selected_page": "search",
        "sort": "date_desc",
        "q": query,
        "type": "json",
        "page": page
    }
    resp = requests.get(API_ENDPOINT, headers=HEADERS, params=params, timeout=15)
    resp.raise_for_status()
    data = resp.json()
    if not isinstance(data, list):
        return []
    return data

def scrape_all_products(query: str, max_pages: int = 50) -> List[Dict]:
    """Scrape multiple pages for a given query."""
    all_products: List[Dict] = []
    for page in range(max_pages):
        print(f"Fetching page {page}...")
        products = fetch_products_page(query=query, page=page)
        if not products:  # No more products
            break

        for product in products:
            if product.get("overallStatus", "").upper() == "SOLD":
                continue  # Skip sold items

            all_products.append({
                "title": product.get("title") or product.get("name"),
                "rental_price": float(product.get("rentalPrice", 0)),
                "retail_price": product.get("retailPrice"),
                "sale_price": product.get("salePrice"),
                "url": f"{BASE_DOMAIN}/product/{product.get('slug')}",
                "image": product.get("image"),
                "brand": product.get("brandName"),
                "category": product.get("categoryName"),
                "for_rent": product.get("forRent") == "1",
                "for_sale": product.get("forSale") == "1",
            })

    return all_products

if __name__ == "__main__":
    SEARCH_QUERY = "red"  # Change your search term here
    print(f"Scraping MyWardrobeHQ for query: '{SEARCH_QUERY}'")
    try:
        products = scrape_all_products(query=SEARCH_QUERY)
    except Exception as e:
        print("Error while scraping:", e)
    else:
        print(f"Found {len(products)} available items.\n")
        for item in products:
            print(item["url"])
